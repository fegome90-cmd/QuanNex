#!/usr/bin/env node

/**
 * Script ejecutable para QuanNex Workflow Enforcement
 * Uso: ./qnx-enforce [check|report|fix]
 */

import QuanNexWorkflowEnforcement from './workflow-enforcement.mjs';
import { writeFileSync } from 'fs';
import { join } from 'path';

async function main() {
  const args = process.argv.slice(2);
  const command = args[0] || 'check';
  
  console.log('ğŸ” QuanNex Workflow Enforcement');
  console.log('================================\n');

  try {
    const enforcement = new QuanNexWorkflowEnforcement();
    
    switch (command) {
      case 'check':
        await runComplianceCheck(enforcement);
        break;
        
      case 'report':
        await generateReport(enforcement);
        break;
        
      case 'fix':
        await suggestFixes(enforcement);
        break;
        
      default:
        console.log('Comandos disponibles:');
        console.log('  check  - Verificar compliance (por defecto)');
        console.log('  report - Generar reporte detallado');
        console.log('  fix    - Sugerir correcciones');
        process.exit(1);
    }
  } catch (error) {
    console.error('âŒ Error ejecutando enforcement:', error.message);
    process.exit(1);
  }
}

async function runComplianceCheck(enforcement) {
  console.log('ğŸ” Verificando compliance con QuanNex...\n');
  
  const report = await enforcement.checkCompliance();
  
  console.log('ğŸ“Š RESULTADOS:');
  console.log(`Estado: ${report.status === 'pass' ? 'âœ… PASS' : 'âŒ FAIL'}`);
  console.log(`Compliance: ${report.overall_compliance.toFixed(1)}%`);
  console.log(`Violaciones: ${report.violations.length}`);
  
  console.log('\nğŸ“ˆ MÃ‰TRICAS:');
  console.log(`  Orchestrator: ${report.metrics.orchestrator_share.toFixed(1)}%`);
  console.log(`  TelemetrÃ­a: ${report.metrics.telemetry_coverage.toFixed(1)}%`);
  console.log(`  Componentes: ${report.metrics.component_usage.toFixed(1)}%`);
  console.log(`  Runs: ${report.metrics.run_success_rate.toFixed(1)}%`);
  
  if (report.violations.length > 0) {
    console.log('\nâš ï¸  VIOLACIONES:');
    report.violations.forEach((violation, index) => {
      console.log(`  ${index + 1}. [${violation.gate}] ${violation.message}`);
    });
  }
  
  if (report.recommendations.length > 0) {
    console.log('\nğŸ’¡ RECOMENDACIONES:');
    report.recommendations.forEach((rec, index) => {
      console.log(`  ${index + 1}. [${rec.priority.toUpperCase()}] ${rec.recommendation}`);
    });
  }
  
  // Guardar reporte
  const reportPath = join(process.cwd(), '.reports/quannex-enforcement-report.json');
  writeFileSync(reportPath, JSON.stringify(report, null, 2));
  console.log(`\nğŸ“„ Reporte: ${reportPath}`);
  
  process.exit(report.status === 'pass' ? 0 : 1);
}

async function generateReport(enforcement) {
  console.log('ğŸ“Š Generando reporte detallado...\n');
  
  const report = await enforcement.checkCompliance();
  
  const htmlReport = generateHTMLReport(report);
  const htmlPath = join(process.cwd(), '.reports/quannex-enforcement-report.html');
  writeFileSync(htmlPath, htmlReport);
  
  console.log('âœ… Reporte HTML:', htmlPath);
  console.log('âœ… Reporte JSON: .reports/quannex-enforcement-report.json');
}

async function suggestFixes(enforcement) {
  console.log('ğŸ”§ Sugiriendo correcciones...\n');
  
  const report = await enforcement.checkCompliance();
  
  if (report.violations.length === 0) {
    console.log('âœ… No hay violaciones. Sistema en compliance.');
    return;
  }
  
  console.log('ğŸ”§ CORRECCIONES:');
  report.recommendations.forEach((rec, index) => {
    console.log(`${index + 1}. ${rec.recommendation}`);
    console.log(`   ${rec.action}`);
    console.log('');
  });
}

function generateHTMLReport(report) {
  return `<!DOCTYPE html>
<html><head><title>QuanNex Enforcement Report</title></head>
<body>
<h1>ğŸ” QuanNex Workflow Enforcement Report</h1>
<p><strong>Estado:</strong> ${report.status === 'pass' ? 'âœ… PASS' : 'âŒ FAIL'}</p>
<p><strong>Compliance:</strong> ${report.overall_compliance.toFixed(1)}%</p>
<h2>ğŸ“ˆ MÃ©tricas</h2>
<p>Orchestrator: ${report.metrics.orchestrator_share.toFixed(1)}%</p>
<p>TelemetrÃ­a: ${report.metrics.telemetry_coverage.toFixed(1)}%</p>
<p>Componentes: ${report.metrics.component_usage.toFixed(1)}%</p>
<p>Runs: ${report.metrics.run_success_rate.toFixed(1)}%</p>
${report.violations.length > 0 ? `<h2>âš ï¸ Violaciones</h2>${report.violations.map(v => `<p><strong>${v.gate}:</strong> ${v.message}</p>`).join('')}` : ''}
${report.recommendations.length > 0 ? `<h2>ğŸ’¡ Recomendaciones</h2>${report.recommendations.map(r => `<p><strong>${r.priority}:</strong> ${r.recommendation}</p>`).join('')}` : ''}
</body></html>`;
}

main().catch(error => {
  console.error('âŒ Error:', error);
  process.exit(1);
});
