#!/usr/bin/env bash
# QuanNex Pre-push Hook
# Verifica firma HMAC del √∫ltimo commit

set -euo pipefail

echo "üîê Verificando firma QuanNex..."

# Verificar que existe la clave de firma
KEY="${QUANNEX_SIGNING_KEY:-}"
if [ -z "$KEY" ]; then
    echo "‚ùå QUANNEX_SIGNING_KEY no configurada"
    echo "Configura: export QUANNEX_SIGNING_KEY='tu-clave-secreta'"
    exit 1
fi

# Obtener mensaje del √∫ltimo commit
MSG=$(git log -1 --pretty=%B)

# Extraer requestId y firma del trailer
REQ=$(echo "$MSG" | sed -n 's/.*requestId=\([^ ]*\).*/\1/p')
SIG=$(echo "$MSG" | sed -n 's/.*sig=\([0-9a-f]*\).*/\1/p')

if [ -z "$REQ" ] || [ -z "$SIG" ]; then
    echo "‚ùå Trailer QuanNex malformado"
    echo "Esperado: QuanNex: requestId=XXX sig=YYY"
    exit 1
fi

# Calcular firma esperada
CALC=$(printf "%s" "$REQ" | openssl dgst -sha256 -hmac "$KEY" | awk '{print $2}')

if [ "$SIG" = "$CALC" ]; then
    echo "‚úÖ Firma QuanNex v√°lida"
    echo "   RequestId: $REQ"
    echo "   Firma: $SIG"
else
    echo "‚ùå FIRMA QUANNEX INV√ÅLIDA"
    echo "   Esperada: $CALC"
    echo "   Recibida: $SIG"
    echo "   RequestId: $REQ"
    exit 1
fi

echo "‚úÖ Pre-push QuanNex: OK"
