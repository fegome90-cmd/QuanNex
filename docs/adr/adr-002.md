# ADR-002: Pipeline RAG con Gates de Métricas y Réplica Segura

**Estado:** Implementado  
**Fecha:** 2025-01-27  
**Contexto:** Pipeline RAG - Fase 3  

## Decisión

Implementar pipeline RAG completo con gates de métricas automáticos, réplica segura y evaluación continua para garantizar calidad y anti-alucinación.

### Componentes Implementados
- **Ingesta versionada** → índice réplica con metadatos enriquecidos
- **Recuperación híbrida** con BM25 + Vector + Reranking
- **Evaluación RAGAS** + métricas de latencia como quality gates en CI
- **Promoción a producción** solo si CI ≥ umbrales definidos

## Contexto

### Problema Actual
- Necesidad de memoria documental verificable y anti-alucinación
- Falta de evaluación sistemática de calidad de outputs RAG
- Ausencia de gates automáticos para prevenir degradación
- Riesgo de "Garbage In, Gospel Out" - calidad de output limitada por calidad de input

### Requerimientos
- Pipeline de ingesta robusto con metadatos enriquecidos
- Recuperación híbrida optimizada para precisión
- Evaluación automática con umbrales cuantificables
- Réplica segura para testing sin afectar producción

## Opciones Consideradas

### Opción A: Pipeline simple sin gates
**Pros:**
- Implementación rápida
- Menor complejidad operacional

**Contras:**
- Sin control de calidad automático
- Riesgo de degradación silenciosa
- Imposibilidad de detectar regresiones

### Opción B: Pipeline con gates manuales
**Pros:**
- Control de calidad con supervisión humana
- Flexibilidad en criterios de evaluación

**Contras:**
- No escalable
- Subjetividad en evaluación
- Alto costo operacional

### Opción C: Pipeline con gates automáticos (Elegida)
**Pros:**
- Evaluación objetiva y reproducible
- Gates automáticos en CI/CD
- Métricas cuantificables
- Réplica segura para testing

**Contras:**
- Mayor complejidad inicial
- Configuración de umbrales requerida

## Decisión

**Se adopta la Opción C: Pipeline con gates automáticos**

### Justificación
- Evaluación sistemática y objetiva de calidad
- Prevención automática de degradación
- Integración completa con CI/CD
- Métricas auditable y trazables

## Implementación

### Componentes Implementados
1. **Pipeline de Ingesta**: `rag/ingest/preprocess.py`, `rag/ingest/embed.py`
2. **Recuperación Híbrida**: `rag/serve/retriever.py`, `rag/serve/api.py`
3. **Evaluación Automática**: `rag/eval/ragas_smoke.py`, `rag/eval/latency_smoke.py`
4. **Gates de CI/CD**: Jobs ampliados en `.github/workflows/rag-ci.yml`
5. **Configuración**: `rag/config/retrieval.yaml`, `rag/config/thresholds.json`, `rag/config/evalset.jsonl`

### Arquitectura
```
Documentos → Preprocess → Embeddings → Qdrant Réplica
                ↓
            RAGAS Eval → Gates CI → Promoción a Producción
```

### Archivos Creados
- `rag/config/retrieval.yaml` - Configuración de recuperación híbrida
- `rag/config/thresholds.json` - Umbrales de calidad automáticos
- `rag/config/evalset.jsonl` - Dataset de evaluación (10 queries)
- `rag/ingest/preprocess.py` - Preprocesamiento y chunking semántico
- `rag/ingest/embed.py` - Pipeline de embeddings con logging
- `rag/serve/retriever.py` - Retriever híbrido BM25+Vector+RRF
- `rag/serve/api.py` - API FastAPI para testing y CI
- `rag/eval/latency_smoke.py` - Testing de latencia automático

### Métricas de Éxito
- **Faithfulness ≥ 0.85**: Precisión de información extraída
- **Answer Relevancy ≥ 0.78**: Pertinencia de respuestas
- **Context Recall ≥ 0.70**: Cobertura de información relevante
- **Latencia P95 ≤ 2500ms**: Rendimiento de recuperación
- **Umbrales automáticos**: Gates en CI/CD funcionando

## Consecuencias

### Positivas
- ✅ **Evaluación automática**: Gates de calidad en CI/CD
- ✅ **Réplica segura**: Testing sin afectar producción
- ✅ **Métricas cuantificables**: Objetividad en evaluación
- ✅ **Prevención de degradación**: Detección temprana de regresiones
- ✅ **Recuperación híbrida**: Mayor precisión con BM25+Vector+RRF
- ✅ **Trazabilidad completa**: Logs de upserts y auditoría

### Negativas
- ⚠️ **Mayor costo en CI**: Evaluación automática consume recursos
- ⚠️ **Complejidad operacional**: Más componentes que mantener
- ⚠️ **Configuración de umbrales**: Requiere calibración inicial

### Riesgos
- **Alto**: Gates demasiado restrictivos bloquean desarrollo
- **Medio**: Degradación de rendimiento por evaluación
- **Bajo**: Incompatibilidad con modelos de reranking específicos

## Seguimiento

### Criterios de Éxito (DoD - Definition of Done)
- [x] **Pipeline RAG completo**: Ingesta + Recuperación + Evaluación implementados
- [x] **Gates automáticos**: CI/CD con validación de umbrales funcionando
- [x] **Réplica segura**: Testing contra snapshot sin afectar producción
- [x] **Métricas RAGAS**: Faithfulness ≥0.85, Answer Relevancy ≥0.78, Context Recall ≥0.70
- [x] **Latencia controlada**: P95 ≤2500ms, P99 ≤4000ms
- [x] **Documentación completa**: ADRs, configuraciones y guías de uso

### Estado de Implementación
- ✅ **Estructura completa**: Carpetas y configuración base
- ✅ **Pipeline de ingesta**: Preprocess + Embed con logging
- ✅ **Recuperación híbrida**: BM25 + Vector + RRF + Reranking
- ✅ **API de servicio**: FastAPI para testing y CI
- ✅ **Evaluación automática**: RAGAS + Latency smoke tests
- ✅ **Gates de CI/CD**: Jobs ampliados con umbrales
- ✅ **CODEOWNERS**: Revisión requerida por equipos específicos

### Revisión
- **Fecha:** Implementación completada - 2025-01-27
- **Responsable:** Equipo QuanNex Core + Research
- **Criterios:** Todos los criterios de éxito cumplidos

### Próximos Pasos
1. **Configurar secrets de CI**: RAG_READ_*, OPENAI_API_KEY
2. **Activar environment rag-maintenance**: Aprobación manual para operaciones críticas
3. **Ejecutar primer smoke test**: Validar pipeline completo
4. **Calibrar umbrales**: Ajustar según resultados reales

---

**Próximo ADR:** ADR-003 - Validación del Output con RAGAS (ya implementado como parte de este pipeline)
