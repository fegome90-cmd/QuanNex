# ADR-004: PRPs como Código - Adopción de DSPy

**Estado:** Propuesto  
**Fecha:** 2025-01-27  
**Contexto:** Pipeline RAG - Fase 3  
**Depende de:** ADR-002 (Calidad del Input), ADR-003 (Validación del Output)

## Decisión

Adoptar DSPy (Declarative Self-improving Python) para formalizar PRPs (Project Reference Protocols) como código reproducible, testeable y optimizable.

## Contexto

### Problema Actual
- PRPs definidos como prompts ad-hoc sin versionado
- Deuda técnica del prompt acumulada
- Imposibilidad de reproducir resultados
- Optimización manual y subjetiva
- Falta de trazabilidad en evolución de prompts

### Requerimientos
- Versionado de PRPs como código
- Reproducibilidad garantizada
- Optimización automática basada en datos
- Integración con pipeline CI de TaskDB
- Formalización de ingesta + retrieval + evaluación

## Opciones Consideradas

### Opción A: Mantener prompts ad-hoc
**Pros:**
- Simplicidad de implementación
- Flexibilidad inmediata

**Contras:**
- Deuda técnica acumulada
- Imposibilidad de reproducibilidad
- Optimización manual
- Falta de trazabilidad

### Opción B: DSPy (Elegida)
**Pros:**
- Framework especializado en optimización de prompts
- Reproducibilidad garantizada
- Optimización automática basada en datos
- Versionado como código
- Integración con ecosistema Python

**Contras:**
- Curva de aprendizaje
- Complejidad inicial de setup

### Opción C: Template system custom
**Pros:**
- Control total sobre implementación
- Optimización específica para casos de uso

**Contras:**
- Alto costo de desarrollo
- Falta de optimización automática
- Mantenimiento complejo

## Decisión

**Se adopta la Opción B: Adopción de DSPy**

### Justificación
- Elimina deuda técnica del prompt
- Garantiza reproducibilidad y versionado
- Optimización automática basada en métricas
- Integración natural con infraestructura evaluada (RAGAS)

## Implementación

### Componentes
1. **DSPy Module**: Formalización de PRP piloto
2. **Versionado**: PRP.lock para reproducibilidad
3. **Optimización**: Tuning automático basado en métricas
4. **CI Integration**: Pipeline automatizado en TaskDB

### PRP Piloto
```python
# prp/pilot_dspy.py
class RAGPipeline(dspy.Module):
    def __init__(self):
        self.retriever = dspy.Retrieve(k=10)
        self.rag = dspy.ChainOfThought("context, question -> answer")
    
    def forward(self, question):
        context = self.retriever(question)
        return self.rag(context=context, question=question)
```

### Optimización Automática
- **BootstrapFewShot**: Aprendizaje de ejemplos
- **BootstrapFewShotWithRandomSearch**: Optimización de hiperparámetros
- **MIPRO**: Optimización multi-objetivo

### Archivos Afectados
- `prp/pilot_dspy.py` (módulo principal)
- `prp/PRP.lock` (versionado de configuración)
- `scripts/ci-prp-optimize.py` (pipeline de optimización)
- `config/dspy.yaml` (configuración de optimización)

### Métricas de Éxito
- Reproducibilidad 100% entre ejecuciones
- Tiempo de optimización < 2 horas
- Mejora en métricas RAGAS > 15%

## Consecuencias

### Positivas
- ✅ PRPs reproducibles y versionados
- ✅ Optimización automática basada en datos
- ✅ Eliminación de deuda técnica del prompt
- ✅ Integración con pipeline CI/CD
- ✅ Trazabilidad completa de evolución

### Negativas
- ⚠️ Curva de aprendizaje inicial
- ⚠️ Complejidad adicional en setup
- ⚠️ Dependencia externa (DSPy)

### Riesgos
- **Alto**: Incompatibilidad con casos de uso específicos
- **Medio**: Degradación de rendimiento en optimización
- **Bajo**: Limitaciones del framework DSPy

## Estrategia de Migración

### Fase 1: Piloto
- Implementar PRP piloto en DSPy
- Validar reproducibilidad
- Medir impacto en métricas

### Fase 2: Optimización
- Configurar optimización automática
- Integrar con métricas RAGAS
- Establecer baseline de rendimiento

### Fase 3: Producción
- Migrar PRPs críticos
- Integrar en pipeline CI
- Monitoreo continuo

## Versionado y Reproducibilidad

### PRP.lock
```yaml
version: "1.0.0"
dspy_version: "2.4.0"
optimization:
  method: "BootstrapFewShotWithRandomSearch"
  max_bootstrapped_demos: 16
  num_candidate_programs: 10
  num_threads: 6
performance:
  fidelity: 0.89
  relevance: 0.85
  recall: 0.82
  precision: 0.87
```

### CI/CD Integration
- Validación automática de PRPs
- Optimización programada
- Rollback automático en degradación
- Notificaciones de cambios significativos

## Seguimiento

### Criterios de Éxito
- [ ] PRP piloto implementado en DSPy
- [ ] Reproducibilidad 100% validada
- [ ] Optimización automática funcionando
- [ ] Integración CI/CD operativa

### Revisión
- **Fecha:** 45 días post-implementación
- **Responsable:** Equipo RAG + ML
- **Criterios:** Cumplimiento de métricas de éxito y efectividad de optimización

---

**Próximo ADR:** ADR-005 - Retrieval Crítico con ColBERT
