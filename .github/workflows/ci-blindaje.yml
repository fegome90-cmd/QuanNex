name: CI Blindaje Anti-ManipulaciÃ³n

on:
  pull_request:
    branches: ['main', 'develop']
  push:
    branches: ['main', 'develop']
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  verify-blindaje:
    runs-on: ubuntu-latest
    name: 'ðŸ”’ VerificaciÃ³n Blindaje Completo'

    steps:
      - name: 'ðŸ“¥ Checkout cÃ³digo'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ðŸ“¦ Instalar dependencias'
        run: npm ci

      - name: 'ðŸ”¨ Build aplicaciÃ³n'
        run: npm run build

      - name: 'ðŸ§ª Tests CI (sin mocks)'
        run: npm run test:ci
        env:
          CI: true
          NODE_ENV: ci

      - name: 'ðŸ“Š Coverage Gate Anti-ManipulaciÃ³n'
        run: npm run gate:coverage

      - name: 'ðŸš€ Iniciar aplicaciÃ³n'
        run: |
          node src/server.mjs &
          echo $! > app.pid
          sleep 3

      - name: 'ðŸ“ˆ Metrics Gate'
        run: npm run gate:metrics

      - name: 'ðŸ” Metrics Integrity Gate'
        run: npm run gate:metrics:integrity

      - name: 'ðŸ”’ Scan Gate'
        run: npm run gate:scan

      - name: 'ðŸ›¡ï¸ Policy Gate'
        run: npm run gate:policy

      - name: 'ðŸš« No-Mock Gate'
        run: npm run gate:nomock

      - name: 'ðŸ“‹ Schema Gate'
        run: npm run gate:schema

      - name: 'ðŸ›¡ï¸ Anti-Tamper Gate'
        run: npm run gate:dirty

      - name: 'ðŸ›‘ Detener aplicaciÃ³n'
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            rm app.pid
          fi

      - name: 'ðŸ“„ Subir reportes'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blindaje-reports
          path: |
            reports/
            artifacts/
            coverage/
          retention-days: 30

  e2e-docker-blindaje:
    runs-on: ubuntu-latest
    name: 'ðŸ³ E2E Docker Blindaje'

    steps:
      - name: 'ðŸ“¥ Checkout cÃ³digo'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ðŸ“¦ Instalar dependencias'
        run: npm ci

      - name: 'ðŸ³ E2E Tests en Docker'
        run: npm run e2e:docker

      - name: 'ðŸ“„ Subir reportes E2E'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-docker-reports
          path: |
            reports/
            artifacts/
          retention-days: 30

  security-blindaje:
    runs-on: ubuntu-latest
    name: 'ðŸ” Security Blindaje'

    steps:
      - name: 'ðŸ“¥ Checkout cÃ³digo'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ðŸ“¦ Instalar dependencias'
        run: npm ci

      - name: 'ðŸ” Gitleaks Secret Scan'
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
          redact: 'true'
          verbose: 'true'

      - name: 'ðŸ›¡ï¸ Security Audit'
        run: npm audit --omit=dev --audit-level=high

      - name: 'ðŸ”’ Policy Check'
        run: npm run gate:policy

      - name: 'ðŸš« No-Mock Gate'
        run: npm run gate:nomock

  mutation-testing:
    runs-on: ubuntu-latest
    name: 'ðŸ§¬ Mutation Testing'
    if: github.event_name == 'pull_request'

    steps:
      - name: 'ðŸ“¥ Checkout cÃ³digo'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ðŸ”§ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ðŸ“¦ Instalar dependencias'
        run: npm ci

      - name: 'ðŸ§¬ Mutation Testing (opcional)'
        run: |
          echo "Mutation testing configurado pero deshabilitado por ahora"
          echo "Para habilitar: npm install --save-dev @stryker-mutator/core @stryker-mutator/vitest-runner"
          echo "Y ejecutar: npx stryker run"

  blindaje-summary:
    runs-on: ubuntu-latest
    name: 'ðŸ“Š Resumen Blindaje'
    needs: [verify-blindaje, e2e-docker-blindaje, security-blindaje]
    if: always()

    steps:
      - name: 'ðŸ“¥ Checkout cÃ³digo'
        uses: actions/checkout@v4

      - name: 'ðŸ“Š Generar resumen'
        run: |
          echo "## ðŸ”’ Resumen Blindaje Anti-ManipulaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Gates Ejecutados:" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage Gate Anti-ManipulaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "- Metrics Integrity Gate" >> $GITHUB_STEP_SUMMARY
          echo "- No-Mock Gate" >> $GITHUB_STEP_SUMMARY
          echo "- Schema Gate" >> $GITHUB_STEP_SUMMARY
          echo "- Anti-Tamper Gate" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Docker Blindaje" >> $GITHUB_STEP_SUMMARY
          echo "- Security Blindaje" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›¡ï¸ Protecciones Activas:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No simulaciÃ³n de mÃ©tricas" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No mocking en CI" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ValidaciÃ³n de esquemas estricta" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cobertura por directorio crÃ­tico" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Working tree limpio" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… E2E en Docker hermÃ©tico" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Estado:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.verify-blindaje.result }}" == "success" ]; then
            echo "- âœ… VerificaciÃ³n Blindaje: **PASÃ“**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ VerificaciÃ³n Blindaje: **FALLÃ“**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.e2e-docker-blindaje.result }}" == "success" ]; then
            echo "- âœ… E2E Docker: **PASÃ“**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ E2E Docker: **FALLÃ“**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.security-blindaje.result }}" == "success" ]; then
            echo "- âœ… Security Blindaje: **PASÃ“**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Security Blindaje: **FALLÃ“**" >> $GITHUB_STEP_SUMMARY
          fi
