name: opa-policy-check (container)
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: opa-container-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  opa:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container: ghcr.io/openpolicyagent/opa:0.58.0

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Build OPA input (labels + changed files)
        id: build-input
        shell: bash
        run: |
          set -euo pipefail
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
          git diff --name-status -M90 "$base" "$head" > diff.txt
          jq -nc \
            --argjson labels '${{ toJson(github.event.pull_request.labels) }}' \
            --arg files "$(awk '{print $2"\n"$3}' diff.txt | sed '/^$/d' | sort -u | tr '\n' ' ')" \
            --arg deleted "$(awk '$1=="D"{print $2}' diff.txt | tr '\n' ' ')" \
            '{
              labels: ( $labels | if .=="" then [] else (fromjson|map(.name)) end ),
              files: ( $files | split(" ") | map(select(length>0)) ),
              deleted_files: ( $deleted | split(" ") | map(select(length>0)) )
            }' > input.json

      - name: Evaluate Rego (policies/)
        shell: bash
        run: |
          set -euo pipefail
          opa eval --format=json -i input.json -d policies/ 'data.pr.deny' > eval.json
          jq -r '.result[0].expressions[0].value[]?' eval.json > violations.txt || true
          if [ -s violations.txt ]; then
            cat violations.txt; exit 1; fi
          echo "OPA OK: no violations."

      - name: Comment violations on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = "❌ **Política PR (container)**:\n\n";
            body += fs.readFileSync('violations.txt','utf8').split('\n').filter(Boolean).map(v=>`- ${v}`).join('\n');
            github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body });
