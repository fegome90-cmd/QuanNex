# Makefile para telemetrÃ­a QuanNex
# Sistema de mediciÃ³n plug-and-play para monitorear uso de QuanNex

.PHONY: telemetry-report telemetry-stats telemetry-clean telemetry-test telemetry-health

# Directorios
TELEMETRY_DIR = .reports/metrics
LOG_FILE = $(TELEMETRY_DIR)/qnx-events.jsonl

# Colores para output
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

##@ TelemetrÃ­a QuanNex

telemetry-report: ## Generar reporte completo de telemetrÃ­a (HTML + JSON)
	@echo "$(GREEN)ðŸ“Š Generando reporte completo de telemetrÃ­a...$(NC)"
	@node scripts/qnx-telemetry-report.mjs

telemetry-stats: ## Mostrar estadÃ­sticas rÃ¡pidas de telemetrÃ­a
	@echo "$(GREEN)ðŸ“ˆ EstadÃ­sticas rÃ¡pidas de telemetrÃ­a:$(NC)"
	@./scripts/qnx-quick-stats.sh

telemetry-health: ## Verificar salud del sistema QuanNex
	@echo "$(GREEN)ðŸ¥ Verificando salud del sistema...$(NC)"
	@if [ -f "$(LOG_FILE)" ]; then \
		ORCHESTRATOR_SHARE=$$(jq -r 'select(.event=="component_used" and .component=="orchestrator")|.run_id' "$(LOG_FILE)" | sort -u | wc -l); \
		TOTAL_RUNS=$$(jq -r 'select(.event=="run_start")|.run_id' "$(LOG_FILE)" | sort -u | wc -l); \
		if [ "$$TOTAL_RUNS" -gt 0 ]; then \
			SHARE=$$((ORCHESTRATOR_SHARE * 100 / TOTAL_RUNS)); \
			if [ "$$SHARE" -ge 95 ]; then \
				echo "$(GREEN)âœ… Orchestrator Share: $$SHARE% (Saludable)$(NC)"; \
			else \
				echo "$(YELLOW)âš ï¸ Orchestrator Share: $$SHARE% (Revisar)$(NC)"; \
			fi; \
		else \
			echo "$(YELLOW)âš ï¸ No hay datos de telemetrÃ­a disponibles$(NC)"; \
		fi; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ archivo de telemetrÃ­a$(NC)"; \
	fi

telemetry-clean: ## Limpiar datos de telemetrÃ­a
	@echo "$(YELLOW)ðŸ§¹ Limpiando datos de telemetrÃ­a...$(NC)"
	@rm -f $(LOG_FILE)
	@rm -f .reports/qnx-telemetry-*.html
	@rm -f .reports/qnx-telemetry-*.json
	@echo "$(GREEN)âœ… Datos de telemetrÃ­a limpiados$(NC)"

telemetry-test: ## Probar sistema de telemetrÃ­a
	@echo "$(GREEN)ðŸ§ª Probando sistema de telemetrÃ­a...$(NC)"
	@mkdir -p $(TELEMETRY_DIR)
	@echo '{"ts":"$(shell date -u +%Y-%m-%dT%H:%M:%S.%3NZ)","run_id":"test-$(shell date +%s)","event":"run_start","ok":true,"meta":{"source":"test","intent":"telemetry_test"}}' >> $(LOG_FILE)
	@echo '{"ts":"$(shell date -u +%Y-%m-%dT%H:%M:%S.%3NZ)","run_id":"test-$(shell date +%s)","event":"component_used","component":"orchestrator","action":"invoke","count":1,"latency_ms":150,"ok":true,"meta":{"test":true}}' >> $(LOG_FILE)
	@echo '{"ts":"$(shell date -u +%Y-%m-%dT%H:%M:%S.%3NZ)","run_id":"test-$(shell date +%s)","event":"run_end","ok":true,"meta":{"test":true}}' >> $(LOG_FILE)
	@echo "$(GREEN)âœ… Eventos de prueba generados$(NC)"
	@make telemetry-stats

telemetry-watch: ## Monitorear telemetrÃ­a en tiempo real
	@echo "$(GREEN)ðŸ‘€ Monitoreando telemetrÃ­a en tiempo real...$(NC)"
	@echo "Presiona Ctrl+C para salir"
	@if command -v tail >/dev/null 2>&1; then \
		tail -f $(LOG_FILE) 2>/dev/null || echo "$(RED)âŒ No hay datos de telemetrÃ­a para monitorear$(NC)"; \
	else \
		echo "$(RED)âŒ Comando 'tail' no disponible$(NC)"; \
	fi

telemetry-export: ## Exportar datos de telemetrÃ­a
	@echo "$(GREEN)ðŸ“¤ Exportando datos de telemetrÃ­a...$(NC)"
	@TIMESTAMP=$$(date +%Y%m%d-%H%M%S); \
	if [ -f "$(LOG_FILE)" ]; then \
		cp $(LOG_FILE) .reports/qnx-telemetry-export-$$TIMESTAMP.jsonl; \
		echo "$(GREEN)âœ… Datos exportados a: .reports/qnx-telemetry-export-$$TIMESTAMP.jsonl$(NC)"; \
	else \
		echo "$(RED)âŒ No hay datos de telemetrÃ­a para exportar$(NC)"; \
	fi

telemetry-import: ## Importar datos de telemetrÃ­a desde archivo
	@echo "$(GREEN)ðŸ“¥ Importando datos de telemetrÃ­a...$(NC)"
	@if [ -z "$(FILE)" ]; then \
		echo "$(RED)âŒ Especifica el archivo: make telemetry-import FILE=archivo.jsonl$(NC)"; \
		exit 1; \
	fi; \
	if [ -f "$(FILE)" ]; then \
		mkdir -p $(TELEMETRY_DIR); \
		cat "$(FILE)" >> $(LOG_FILE); \
		echo "$(GREEN)âœ… Datos importados desde: $(FILE)$(NC)"; \
	else \
		echo "$(RED)âŒ Archivo no encontrado: $(FILE)$(NC)"; \
	fi

telemetry-setup: ## Configurar sistema de telemetrÃ­a
	@echo "$(GREEN)âš™ï¸ Configurando sistema de telemetrÃ­a...$(NC)"
	@mkdir -p $(TELEMETRY_DIR)
	@mkdir -p .reports
	@echo "$(GREEN)âœ… Directorios creados$(NC)"
	@echo "$(YELLOW)ðŸ“ Para habilitar telemetrÃ­a, asegÃºrate de que:$(NC)"
	@echo "   1. El servidor MCP incluye el middleware de telemetrÃ­a"
	@echo "   2. Los tools MCP estÃ¡n instrumentados"
	@echo "   3. Los gates estÃ¡n configurados correctamente"

telemetry-dashboard: ## Abrir dashboard de telemetrÃ­a en navegador
	@echo "$(GREEN)ðŸŒ Abriendo dashboard de telemetrÃ­a...$(NC)"
	@if [ -f ".reports/qnx-telemetry-report.html" ]; then \
		if command -v open >/dev/null 2>&1; then \
			open .reports/qnx-telemetry-report.html; \
		elif command -v xdg-open >/dev/null 2>&1; then \
			xdg-open .reports/qnx-telemetry-report.html; \
		else \
			echo "$(YELLOW)ðŸ“„ Abre manualmente: .reports/qnx-telemetry-report.html$(NC)"; \
		fi; \
	else \
		echo "$(YELLOW)ðŸ“Š Generando reporte primero...$(NC)"; \
		make telemetry-report; \
		make telemetry-dashboard; \
	fi

##@ Ayuda

help: ## Mostrar esta ayuda
	@awk 'BEGIN {FS = ":.*##"; printf "\n$(GREEN)TelemetrÃ­a QuanNex$(NC)\n\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2 } /^##@/ { printf "\n$(GREEN)%s$(NC)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

# ConfiguraciÃ³n por defecto
.DEFAULT_GOAL := help
