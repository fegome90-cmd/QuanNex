<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard MCP - Tiempo Real</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #0d1117;
            color: #e6edf3;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
        }

        .header h1 {
            color: #58a6ff;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status.online { background: #238636; color: white; }
        .status.offline { background: #da3633; color: white; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .card h3 {
            color: #f0f6fc;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: #0d1117;
            border-radius: 4px;
        }

        .metric-label {
            color: #7d8590;
        }

        .metric-value {
            color: #e6edf3;
            font-weight: bold;
        }

        .metric-value.good { color: #3fb950; }
        .metric-value.warning { color: #d29922; }
        .metric-value.error { color: #f85149; }

        .chart {
            height: 200px;
            background: #0d1117;
            border-radius: 4px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        .chart-line {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(to top, #238636, transparent);
            opacity: 0.3;
        }

        .alerts {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .alert {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid;
        }

        .alert.warning {
            background: #fff8c5;
            color: #9a6700;
            border-left-color: #d29922;
        }

        .alert.error {
            background: #ffdcd7;
            color: #8b0000;
            border-left-color: #f85149;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7d8590;
            font-size: 14px;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            background: #238636;
            border-radius: 4px;
            font-size: 12px;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸš€ Dashboard MCP - Tiempo Real</h1>
        <p>Monitoreo de Agentes MCP</p>
        <span id="connection-status" class="status offline">Desconectado</span>
        <div class="refresh-indicator" id="last-update">Ãšltima actualizaciÃ³n: --</div>
    </div>

    <div class="grid" id="agents-grid">
        <!-- Los agentes se cargarÃ¡n dinÃ¡micamente -->
    </div>

    <div class="alerts">
        <h3>ðŸš¨ Alertas</h3>
        <div id="alerts-container">
            <p style="color: #7d8590;">No hay alertas activas</p>
        </div>
    </div>

    <div class="footer">
        <p>Dashboard MCP v1.0 | ActualizaciÃ³n automÃ¡tica cada 5 segundos</p>
    </div>

    <script>
        class MCPDashboard {
            constructor() {
                this.agents = ['context', 'prompting', 'rules'];
                this.updateInterval = 5000; // 5 segundos
                this.isConnected = false;
                this.init();
            }

            init() {
                this.createAgentCards();
                this.startPolling();
                this.updateConnectionStatus(true);
            }

            createAgentCards() {
                const grid = document.getElementById('agents-grid');
                grid.innerHTML = '';

                this.agents.forEach(agent => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.id = `agent-${agent}`;
                    card.innerHTML = `
                        <h3>
                            <span>ðŸ¤–</span>
                            ${agent.toUpperCase()}
                            <span id="status-${agent}" class="status offline">Offline</span>
                        </h3>
                        <div class="metric">
                            <span class="metric-label">Latencia Promedio</span>
                            <span class="metric-value" id="latency-${agent}">-- ms</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Tasa de Ã‰xito</span>
                            <span class="metric-value" id="success-${agent}">-- %</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Tests Totales</span>
                            <span class="metric-value" id="total-${agent}">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">P95</span>
                            <span class="metric-value" id="p95-${agent}">-- ms</span>
                        </div>
                        <div class="chart">
                            <div class="chart-line" id="chart-${agent}"></div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            async fetchMetrics() {
                try {
                    const response = await fetch('/api/metrics');
                    if (!response.ok) throw new Error('Error en la respuesta');
                    
                    const data = await response.json();
                    this.updateDashboard(data);
                    this.updateConnectionStatus(true);
                    return data;
                } catch (error) {
                    console.error('Error fetching metrics:', error);
                    this.updateConnectionStatus(false);
                    return null;
                }
            }

            updateDashboard(data) {
                if (!data || !data.agents) return;

                Object.entries(data.agents).forEach(([agent, metrics]) => {
                    this.updateAgentCard(agent, metrics);
                });

                this.updateAlerts(data);
                this.updateLastUpdate();
            }

            updateAgentCard(agent, metrics) {
                // Actualizar estado
                const statusEl = document.getElementById(`status-${agent}`);
                statusEl.textContent = 'Online';
                statusEl.className = 'status online';

                // Actualizar mÃ©tricas
                const latencyEl = document.getElementById(`latency-${agent}`);
                latencyEl.textContent = `${metrics.avgLatency} ms`;
                latencyEl.className = `metric-value ${this.getLatencyClass(metrics.avgLatency)}`;

                const successEl = document.getElementById(`success-${agent}`);
                successEl.textContent = `${metrics.successRate} %`;
                successEl.className = `metric-value ${this.getSuccessClass(metrics.successRate)}`;

                const totalEl = document.getElementById(`total-${agent}`);
                totalEl.textContent = metrics.total;

                const p95El = document.getElementById(`p95-${agent}`);
                p95El.textContent = `${metrics.p95} ms`;
                p95El.className = `metric-value ${this.getLatencyClass(metrics.p95)}`;

                // Actualizar grÃ¡fico simple
                this.updateChart(agent, metrics.avgLatency);
            }

            getLatencyClass(latency) {
                if (latency < 50) return 'good';
                if (latency < 100) return 'warning';
                return 'error';
            }

            getSuccessClass(rate) {
                if (rate >= 95) return 'good';
                if (rate >= 90) return 'warning';
                return 'error';
            }

            updateChart(agent, latency) {
                const chartEl = document.getElementById(`chart-${agent}`);
                const height = Math.min((latency / 200) * 100, 100);
                chartEl.style.height = `${height}%`;
            }

            updateAlerts(data) {
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = '';

                const alerts = [];
                
                if (data.agents) {
                    Object.entries(data.agents).forEach(([agent, metrics]) => {
                        if (metrics.avgLatency > 100) {
                            alerts.push({
                                type: 'warning',
                                message: `Latencia alta en ${agent}: ${metrics.avgLatency}ms`
                            });
                        }
                        if (metrics.successRate < 95) {
                            alerts.push({
                                type: 'error',
                                message: `Tasa de Ã©xito baja en ${agent}: ${metrics.successRate}%`
                            });
                        }
                    });
                }

                if (alerts.length === 0) {
                    alertsContainer.innerHTML = '<p style="color: #7d8590;">No hay alertas activas</p>';
                } else {
                    alerts.forEach(alert => {
                        const alertEl = document.createElement('div');
                        alertEl.className = `alert ${alert.type}`;
                        alertEl.textContent = alert.message;
                        alertsContainer.appendChild(alertEl);
                    });
                }
            }

            updateConnectionStatus(connected) {
                this.isConnected = connected;
                const statusEl = document.getElementById('connection-status');
                statusEl.textContent = connected ? 'Conectado' : 'Desconectado';
                statusEl.className = `status ${connected ? 'online' : 'offline'}`;
            }

            updateLastUpdate() {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                document.getElementById('last-update').textContent = `Ãšltima actualizaciÃ³n: ${timeString}`;
            }

            startPolling() {
                this.fetchMetrics();
                setInterval(() => {
                    this.fetchMetrics();
                }, this.updateInterval);
            }
        }

        // Inicializar dashboard cuando se carga la pÃ¡gina
        document.addEventListener('DOMContentLoaded', () => {
            new MCPDashboard();
        });
    </script>
</body>
</html>
