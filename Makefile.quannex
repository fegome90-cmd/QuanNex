# Quannex Context Agent - Makefile para Laboratorio Docker
# Laboratorio de experimentos para calibraciÃ³n mÃ¡xima de rendimiento

.PHONY: help context-build context-up context-down context-bench context-analyze context-tune-lite context-tune-aggr context-tune-prod context-logs context-health context-clean

# Variables por defecto
DOCKER_COMPOSE_FILE = docker/context/compose.yml
CONTEXT_IMAGE = quannex/context:latest
BENCH_OUTPUT = logs/context-bench.jsonl
ANALYSIS_OUTPUT = logs/context-bench-analysis.json

# Colores para output
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

help: ## Mostrar ayuda del laboratorio Quannex
	@echo "$(BLUE)ğŸš€ QUANNEX CONTEXT AGENT - LABORATORIO DOCKER$(NC)"
	@echo ""
	@echo "$(GREEN)ğŸ“‹ COMANDOS PRINCIPALES:$(NC)"
	@echo "  context-build     Construir imagen Docker del Context Agent"
	@echo "  context-up        Levantar servicio Context Agent"
	@echo "  context-down      Detener servicio Context Agent"
	@echo "  context-bench     Ejecutar benchmark de carga"
	@echo "  context-analyze   Analizar mÃ©tricas del benchmark"
	@echo ""
	@echo "$(GREEN)âš™ï¸  COMANDOS DE TUNING:$(NC)"
	@echo "  context-tune-lite    ConfiguraciÃ³n ligera (RPS bajo)"
	@echo "  context-tune-aggr     ConfiguraciÃ³n agresiva (RPS alto)"
	@echo "  context-tune-prod     ConfiguraciÃ³n producciÃ³n optimizada"
	@echo "  context-tune-tight    ConfiguraciÃ³n producciÃ³n tight (P95â‰¤100ms, P99â‰¤200ms)"
	@echo ""
	@echo "$(GREEN)ğŸ” COMANDOS DE MONITOREO:$(NC)"
	@echo "  context-logs      Ver logs del Context Agent"
	@echo "  context-health    Verificar salud del servicio"
	@echo "  context-clean     Limpiar artefactos del laboratorio"
	@echo ""
	@echo "$(GREEN)ğŸ¯ COMANDOS DE CALIDAD:$(NC)"
	@echo "  context-quality              Ejecutar suite completa de tests de calidad"
	@echo "  context-quality-consistency  Ejecutar test de consistencia"
	@echo "  context-quality-replay       Ejecutar test de replay"
	@echo ""
	@echo "$(GREEN)ğŸš€ COMANDOS DE RATE LIMITING:$(NC)"
	@echo "  context-rate-limit-test      Ejecutar stress test de rate limiting"
	@echo "  context-apply-tight-config  Aplicar configuraciÃ³n tight con admission control"
	@echo ""
	@echo "$(GREEN)ğŸ¯ FLUJO RECOMENDADO:$(NC)"
	@echo "  1. make context-build"
	@echo "  2. make context-up"
	@echo "  3. make context-bench"
	@echo "  4. make context-analyze"
	@echo "  5. make context-tune-aggr"
	@echo "  6. make context-bench"
	@echo "  7. make context-analyze"

context-build: ## Construir imagen Docker del Context Agent
	@echo "$(BLUE)ğŸ”¨ Construyendo imagen Docker del Context Agent...$(NC)"
	docker compose -f $(DOCKER_COMPOSE_FILE) build context
	@echo "$(GREEN)âœ… Imagen construida: $(CONTEXT_IMAGE)$(NC)"

context-up: ## Levantar servicio Context Agent
	@echo "$(BLUE)ğŸš€ Levantando servicio Context Agent...$(NC)"
	docker compose -f $(DOCKER_COMPOSE_FILE) up -d context
	@echo "$(GREEN)âœ… Servicio levantado en puerto 8601$(NC)"
	@echo "$(YELLOW)ğŸ“Š Health check: http://localhost:8601/health$(NC)"

context-down: ## Detener servicio Context Agent
	@echo "$(BLUE)ğŸ›‘ Deteniendo servicio Context Agent...$(NC)"
	docker compose -f $(DOCKER_COMPOSE_FILE) down
	@echo "$(GREEN)âœ… Servicio detenido$(NC)"

context-bench: ## Ejecutar benchmark de carga
	@echo "$(BLUE)ğŸ“Š Ejecutando benchmark de carga...$(NC)"
	@mkdir -p logs
	docker compose -f $(DOCKER_COMPOSE_FILE) run --rm bench
	@echo "$(GREEN)âœ… Benchmark completado: $(BENCH_OUTPUT)$(NC)"

context-analyze: ## Analizar mÃ©tricas del benchmark
	@echo "$(BLUE)ğŸ“ˆ Analizando mÃ©tricas del benchmark...$(NC)"
	@if [ ! -f $(BENCH_OUTPUT) ]; then \
		echo "$(RED)âŒ Archivo de benchmark no encontrado: $(BENCH_OUTPUT)$(NC)"; \
		echo "$(YELLOW)ğŸ’¡ Ejecuta 'make context-bench' primero$(NC)"; \
		exit 1; \
	fi
	node tools/context-analyze.mjs $(BENCH_OUTPUT)
	@echo "$(GREEN)âœ… AnÃ¡lisis completado$(NC)"

context-tune-lite: ## ConfiguraciÃ³n ligera (RPS bajo)
	@echo "$(BLUE)âš™ï¸  Aplicando configuraciÃ³n ligera...$(NC)"
	CONTEXT_SUMMARY_MAX=1000 \
	CONTEXT_LRU_SIZE=256 \
	CONTEXT_DISABLE_RAG=1 \
	CONTEXT_PARALLEL_IO=2 \
	UV_THREADPOOL_SIZE=4 \
	docker compose -f $(DOCKER_COMPOSE_FILE) up -d --build context
	@echo "$(GREEN)âœ… ConfiguraciÃ³n ligera aplicada$(NC)"

context-tune-aggr: ## ConfiguraciÃ³n agresiva (RPS alto)
	@echo "$(BLUE)âš™ï¸  Aplicando configuraciÃ³n agresiva...$(NC)"
	CONTEXT_SUMMARY_MAX=500 \
	CONTEXT_LRU_SIZE=1024 \
	CONTEXT_DISABLE_RAG=1 \
	CONTEXT_PRUNE_SCORE=0.28 \
	CONTEXT_PARALLEL_IO=8 \
	UV_THREADPOOL_SIZE=16 \
	docker compose -f $(DOCKER_COMPOSE_FILE) up -d --build context
	@echo "$(GREEN)âœ… ConfiguraciÃ³n agresiva aplicada$(NC)"

context-tune-prod: ## ConfiguraciÃ³n producciÃ³n optimizada
	@echo "$(BLUE)ğŸ­ Aplicando preset de producciÃ³n optimizado...$(NC)"
	@echo "$(YELLOW)ğŸ“Š Objetivos: P95 â‰¤ 100ms, tokens â‰¤ 600, memoria estable$(NC)"
	@echo "$(YELLOW)ğŸ”§ Valores validados con benchmark real$(NC)"
	CONTEXT_SUMMARY_MAX=500 \
	CONTEXT_LRU_SIZE=1024 \
	CONTEXT_RECALL_STRATEGY=hybrid \
	CONTEXT_DISABLE_RAG=1 \
	CONTEXT_PRUNE_SCORE=0.30 \
	CONTEXT_PARALLEL_IO=6 \
	UV_THREADPOOL_SIZE=12 \
	NODE_OPTIONS="--max-old-space-size=1024" \
	NODE_ENV=production \
	docker compose -f $(DOCKER_COMPOSE_FILE) up -d --build context
	@echo "$(GREEN)âœ… Preset de producciÃ³n aplicado$(NC)"
	@echo "$(YELLOW)ğŸ“ˆ MÃ©tricas esperadas: P95=75ms, P99=108ms, Tokens=499$(NC)"

context-tune-tight: ## ConfiguraciÃ³n producciÃ³n tight (P95â‰¤100ms, P99â‰¤200ms)
	@echo "$(BLUE)ğŸ¯ Aplicando preset de producciÃ³n tight...$(NC)"
	@echo "$(YELLOW)ğŸ“Š Objetivos: P95 â‰¤ 100ms, P99 â‰¤ 200ms, optimizaciones quirÃºrgicas$(NC)"
	@echo "$(YELLOW)ğŸ”§ Keep-alive + logging async + warm-up + micro-timeouts$(NC)"
	CONTEXT_SUMMARY_MAX=400 \
	CONTEXT_LRU_SIZE=2048 \
	CONTEXT_RECALL_STRATEGY=hybrid \
	CONTEXT_DISABLE_RAG=1 \
	CONTEXT_PRUNE_SCORE=0.25 \
	CONTEXT_PARALLEL_IO=4 \
	UV_THREADPOOL_SIZE=8 \
	NODE_OPTIONS="--max-old-space-size=1024 --max-semi-space-size=32 --initial-old-space-size=256" \
	INTERNAL_STEP_DEADLINE_MS=80 \
	NODE_ENV=production \
	docker compose -f $(DOCKER_COMPOSE_FILE) up -d --build context
	@echo "$(GREEN)âœ… Preset de producciÃ³n tight aplicado$(NC)"
	@echo "$(YELLOW)ğŸ“ˆ MÃ©tricas esperadas: P95â‰¤100ms, P99â‰¤200ms, Tokensâ‰¤500$(NC)"
	@echo "$(YELLOW)ğŸš€ Optimizaciones: Keep-alive, async logging, warm-up, micro-timeouts$(NC)"

context-logs: ## Ver logs del Context Agent
	@echo "$(BLUE)ğŸ“‹ Mostrando logs del Context Agent...$(NC)"
	docker compose -f $(DOCKER_COMPOSE_FILE) logs -f context

context-health: ## Verificar salud del servicio
	@echo "$(BLUE)ğŸ¥ Verificando salud del Context Agent...$(NC)"
	@curl -s http://localhost:8601/health | jq . || echo "$(RED)âŒ Servicio no disponible$(NC)"

context-clean: ## Limpiar artefactos del laboratorio
	@echo "$(BLUE)ğŸ§¹ Limpiando artefactos del laboratorio...$(NC)"
	docker compose -f $(DOCKER_COMPOSE_FILE) down --volumes --remove-orphans
	docker rmi $(CONTEXT_IMAGE) 2>/dev/null || true
	rm -f $(BENCH_OUTPUT) $(BENCH_OUTPUT).hash $(ANALYSIS_OUTPUT) 2>/dev/null || true
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

# Comandos de flujo completo
context-full-test: context-build context-up context-bench context-analyze ## Ejecutar flujo completo de testing
	@echo "$(GREEN)ğŸ¯ Flujo completo de testing completado$(NC)"

context-performance-test: context-build context-up context-bench context-analyze context-tune-aggr context-bench context-analyze ## Ejecutar test de rendimiento completo
	@echo "$(GREEN)ğŸ† Test de rendimiento completado$(NC)"

context-quality: ## Ejecutar tests de calidad del contexto
	@echo "$(BLUE)ğŸ¯ Ejecutando tests de calidad del contexto...$(NC)"
	@mkdir -p quality-tests/context/reports
	node quality-tests/context/context-quality.mjs
	@echo "$(GREEN)âœ… Tests de calidad completados$(NC)"

context-quality-consistency: ## Ejecutar test de consistencia
	@echo "$(BLUE)ğŸ” Ejecutando test de consistencia...$(NC)"
	node quality-tests/context/check-consistency.mjs
	@echo "$(GREEN)âœ… Test de consistencia completado$(NC)"

context-quality-replay: ## Ejecutar test de replay
	@echo "$(BLUE)ğŸ”„ Ejecutando test de replay...$(NC)"
	node quality-tests/context/replay-test.mjs
	@echo "$(GREEN)âœ… Test de replay completado$(NC)"

context-rate-limit-test: ## Ejecutar stress test de rate limiting
	@echo "$(BLUE)ğŸš€ Ejecutando stress test de rate limiting...$(NC)"
	node tests/load/rate-limit-stress-test.mjs
	@echo "$(GREEN)âœ… Stress test completado$(NC)"

context-apply-tight-config: ## Aplicar configuraciÃ³n tight con admission control
	@echo "$(BLUE)ğŸ¯ Aplicando configuraciÃ³n tight con admission control...$(NC)"
	@echo "$(YELLOW)ğŸ“Š ConfiguraciÃ³n: Token bucket, circuit breaker, degradaciÃ³n progresiva$(NC)"
	@if [ -f config/prod-tight.env ]; then \
		set -a && \
		. config/prod-tight.env && \
		set +a && \
		docker compose -f $(DOCKER_COMPOSE_FILE) up -d --build context; \
	else \
		echo "$(RED)âŒ Error: config/prod-tight.env no encontrado$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… ConfiguraciÃ³n tight aplicada$(NC)"
	@echo "$(YELLOW)ğŸ“ˆ MÃ©tricas esperadas: Resistente a rate limits, degradaciÃ³n progresiva$(NC)"

# Comandos de desarrollo
context-dev: context-build context-up context-logs ## Modo desarrollo con logs

context-restart: context-down context-up ## Reiniciar servicio

# InformaciÃ³n del sistema
context-info: ## Mostrar informaciÃ³n del laboratorio
	@echo "$(BLUE)ğŸ“Š INFORMACIÃ“N DEL LABORATORIO QUANNEX$(NC)"
	@echo ""
	@echo "$(GREEN)ğŸ³ Docker Compose:$(NC)"
	@echo "  Archivo: $(DOCKER_COMPOSE_FILE)"
	@echo "  Imagen: $(CONTEXT_IMAGE)"
	@echo ""
	@echo "$(GREEN)ğŸ“ Archivos de salida:$(NC)"
	@echo "  Benchmark: $(BENCH_OUTPUT)"
	@echo "  AnÃ¡lisis: $(ANALYSIS_OUTPUT)"
	@echo ""
	@echo "$(GREEN)ğŸŒ Endpoints:$(NC)"
	@echo "  Health: http://localhost:8601/health"
	@echo "  Context: http://localhost:8601/context/get"
	@echo ""
	@echo "$(GREEN)âš™ï¸  Palancas de rendimiento disponibles:$(NC)"
	@echo "  CONTEXT_SUMMARY_MAX (256-10000)"
	@echo "  CONTEXT_LRU_SIZE (64-2048)"
	@echo "  CONTEXT_DISABLE_RAG (0|1)"
	@echo "  CONTEXT_PRUNE_SCORE (0.0-1.0)"
	@echo "  CONTEXT_PARALLEL_IO (1-16)"
	@echo "  UV_THREADPOOL_SIZE (1-32)"
